rules_version = '2';

// Firebase Storage Security Rules for Daggerheart Campaign Manager
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get campaign data from Firestore
    function getCampaign(campaignId) {
      return firestore.get(/databases/(default)/documents/campaigns/$(campaignId));
    }

    // Helper function to check if user is a member of the campaign
    function isCampaignMember(campaignId) {
      let campaign = getCampaign(campaignId);
      return request.auth.uid in campaign.data.members;
    }

    // Helper function to check if user is a DM of the campaign
    function isCampaignDM(campaignId) {
      let campaign = getCampaign(campaignId);
      let member = campaign.data.members[request.auth.uid];
      return member.role == 'dm';
    }

    // Campaign files rules
    match /campaigns/{campaignId}/files/{fileName} {
      // Allow read if user is a member of the campaign
      allow read: if isAuthenticated() && isCampaignMember(campaignId);

      // Allow write (upload) if user is a DM of the campaign
      allow create: if isAuthenticated() && isCampaignDM(campaignId)
                    && request.resource.size < 10 * 1024 * 1024; // Max 10MB

      // Allow delete if user is a DM of the campaign
      allow delete: if isAuthenticated() && isCampaignDM(campaignId);
    }

    // Campaign map images rules
    match /campaigns/{campaignId}/maps/{fileName} {
      // Allow read if user is a member of the campaign
      allow read: if isAuthenticated() && isCampaignMember(campaignId);

      // Allow write (upload) if user is a member (maps can be generated by anyone)
      allow create: if isAuthenticated() && isCampaignMember(campaignId)
                    && request.resource.size < 10 * 1024 * 1024; // Max 10MB

      // Allow delete if user is a DM of the campaign
      allow delete: if isAuthenticated() && isCampaignDM(campaignId);
    }

    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
